<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="google-site-verification" content="aG_tXROG9wF9yK4g29KmnltUUXyLK5SBAWKIXDkz6vU"><title>A bug which should have been solved a week ago - Fedeoo&#039;s Blog</title><link rel="manifest" href="/en/manifest.json"><meta name="application-name" content="Fedeoo&#039;s Blog"><meta name="msapplication-TileImage" content="/gallery/site/shark.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Fedeoo&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Recently,  we have a DS ticket that said a user got banner error periodically on the home page.  That means we got some BE errors on API requests. I checked NewRelic and nothing exception was found."><meta property="og:type" content="blog"><meta property="og:title" content="A bug which should have been solved a week ago"><meta property="og:url" content="http://blog.feibyte.com/en/2020/02/14/novice/cache-memory-issue/"><meta property="og:site_name" content="Fedeoo&#039;s Blog"><meta property="og:description" content="Recently,  we have a DS ticket that said a user got banner error periodically on the home page.  That means we got some BE errors on API requests. I checked NewRelic and nothing exception was found."><meta property="og:locale" content="en_US"><meta property="og:image" content="http://blog.feibyte.com/en/gallery/thumbnails/troubleshooting.jpg"><meta property="article:published_time" content="2020-02-14T11:05:00.000Z"><meta property="article:modified_time" content="2024-05-16T12:28:15.299Z"><meta property="article:author" content="Fedeoo"><meta property="article:tag" content="troubleshooting"><meta property="article:tag" content="apollo-data-source"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://blog.feibyte.com/en/gallery/thumbnails/troubleshooting.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://blog.feibyte.com/en/2020/02/14/novice/cache-memory-issue/"},"headline":"A bug which should have been solved a week ago","image":["http://blog.feibyte.com/en/gallery/thumbnails/troubleshooting.jpg"],"datePublished":"2020-02-14T11:05:00.000Z","dateModified":"2024-05-16T12:28:15.299Z","author":{"@type":"Person","name":"Fedeoo"},"publisher":{"@type":"Organization","name":"Fedeoo's Blog","logo":{"@type":"ImageObject","url":"http://blog.feibyte.com/gallery/site/logo.png"}},"description":"Recently,  we have a DS ticket that said a user got banner error periodically on the home page.  That means we got some BE errors on API requests. I checked NewRelic and nothing exception was found."}</script><link rel="canonical" href="http://blog.feibyte.com/en/2020/02/14/novice/cache-memory-issue/"><link rel="icon" href="/en/gallery/site/shark.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/en/css/default.css"><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-773NDPTQE0" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-773NDPTQE0');</script><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/en/"><img src="/en/gallery/site/logo.png" alt="Fedeoo&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/en/">Home</a><a class="navbar-item" href="/en/archives">Archives</a><a class="navbar-item" href="/en/categories">Categories</a><a class="navbar-item" href="/en/tags">Tags</a><a class="navbar-item" href="/en/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="简体中文" href="https://blog.feibyte.com/">简体中文</a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/feibyte/feibyte.github.io"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-02-14T11:05:00.000Z" title="14/02/2020, 10:05:00 pm">2020-02-14</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-05-16T12:28:15.299Z" title="16/05/2024, 10:28:15 pm">2024-05-16</time></span><span class="level-item"><a class="link-muted" href="/en/categories/Explorations/">Explorations</a></span><span class="level-item">4 minutes read (About 626 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">A bug which should have been solved a week ago</h1><div class="content"><p>Recently,  we have a DS ticket that said a user got banner error periodically on the home page.  That means we got some BE errors on API requests. I checked NewRelic and nothing exception was found.  I checked error logs on our server and only a few 500 errors.  I can’t find further information about these errors. So I believe it was caused by an unstable network or it might be caused.  I was not working on that task.</p>
<p>Until yesterday we were going to solve a cache memory issue and I still not realized that was caused by cache memory.  After I had submitted that PR of fixing cache memory, I decided to look that DS ticket again. I notice there’s some clue. I could find banner errors on fullstory and that means we did get some request errors.  Then I checked request logs on Cloudflare and here are unsuccessful requests.</p>
<span id="more"></span>

<p><img src="/en/gallery/site/cache-memory-1.png" alt="Last 3 days&#39; unsuccessful requests">  </p>
<p>We should notice that not all the unsuccessful requests matter because some of them are from scanners and attackers. If we look into the intensive bar, we notice that most of the errors are 5** error. We got this error probably because of the unavailable server. Let’s take a look at all 502 errors. </p>
<p><img src="/en/gallery/site/cache-memory-2.png" alt="502 resposnse">  </p>
<p>Then I notice that the chart is highly correlated to our server up-down.</p>
<p><img src="/en/gallery/site/cache-memory-3.png" alt="Newrelic log">  </p>
<p>So, That errors must be caused by the memory issue.</p>
<p>Basically, we’re caching the requests to microservices.  The problem is the cache instance is infinite by default.  <a target="_blank" rel="noopener" href="https://github.com/apollographql/apollo-server/issues/2252">https://github.com/apollographql/apollo-server/issues/2252</a></p>
<h2 id="Misunderstand-about-zero-downtime"><a href="#Misunderstand-about-zero-downtime" class="headerlink" title="Misunderstand about zero downtime"></a>Misunderstand about zero downtime</h2><p>As we might know when we’re deploying a new update. A new docker image will be created and we start up 2 new instances. Then the load balancer will refer to the new instances once they are healthy.  Then it’s safe for us to delete the old instances.</p>
<p>I didn’t take it seriously when I saw the containers were down and up.  As I thought it should be looked after by AWS agents and we won’t have downtime.  When I looked at the chart, I was further convinced. Look, before the old container is down, a new container is already up. It’s awesome!</p>
<p>Unfortunately, we still got 502 errors. But Why? 🤔</p>
<p>The reason is we were not closing the old container deliberately.  The old container dead of using out of memory.  During that time(might be a few seconds), the request was assigned to that old container.</p>
<h2 id="Self-Review"><a href="#Self-Review" class="headerlink" title="Self Review"></a>Self Review</h2><p>I didn’t know that the max size is infinite in the beginning.  I did find that memory was increasing a few weeks ago but I didn’t take it seriously as the misunderstanding I mentioned above.</p>
<p>I could do better is to solve it immediately.  Two things to help to debug: Talk to the people who report that bug; Check everything in that task.</p>
<h2 id="Some-tips-of-troubleshooting"><a href="#Some-tips-of-troubleshooting" class="headerlink" title="Some tips of troubleshooting"></a>Some tips of troubleshooting</h2><p>The most important thing to debug is to restore the error. If we could reproduce it, usually it’s easy to fix it. Basically, it’s hard to debug occasional errors.  Once we know some user info, we could check fullstory and see the original errors.  Once we know the accurate time, we could check all the logs during that period.  </p>
<p>The last critical thing from this lesson is prepare it beforehand. Before any alerts are triggered, we’d better understand what normal error we have.</p>
<p>In the next few days, I get to watch the error logs of Cloudflare, Newrelic and ensure I understand every error.</p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/en/tags/troubleshooting/">troubleshooting</a><a class="link-muted mr-2" rel="tag" href="/en/tags/apollo-data-source/">apollo-data-source</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/en/2024/05/11/How-to-prevent-duplicate-SQS-messages/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">How to prevent duplicate SQS messages</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/en/2020/01/17/journeyman/Auth0-lock-issue/"><span class="level-item">Auth0 lock issue</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'http://blog.feibyte.com/en/2020/02/14/novice/cache-memory-issue/';
            this.page.identifier = '2020/02/14/novice/cache-memory-issue/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'blog-feibyte-com' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/en/gallery/site/shark.png" alt="Fedeoo"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Fedeoo</p><p class="is-size-6 is-block">Engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Sydney</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/en/archives"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Category</p><a href="/en/categories"><p class="title">1</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/en/tags"><p class="title">12</p></a></div></div></nav></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/en/categories/Explorations/"><span class="level-start"><span class="level-item">Explorations</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><figure class="media-left"><a class="image" href="/en/2024/06/02/DynamoDB%20single%20table%20design/"><img src="/en/gallery/thumbnails/2024/dynamodb.png" alt="DynamoDB the Advantages and Considerations of Single Table Design"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-06-02T11:22:56.000Z">2024-06-02</time></p><p class="title"><a href="/en/2024/06/02/DynamoDB%20single%20table%20design/">DynamoDB the Advantages and Considerations of Single Table Design</a></p><p class="categories"><a href="/en/categories/Explorations/">Explorations</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/en/2024/05/21/AWS-connect-last-agent-call-routing/"><img src="/en/gallery/thumbnails/2024/call-center.png" alt="AWS connect last agent call routing"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-05-21T11:22:56.000Z">2024-05-21</time></p><p class="title"><a href="/en/2024/05/21/AWS-connect-last-agent-call-routing/">AWS connect last agent call routing</a></p><p class="categories"><a href="/en/categories/Explorations/">Explorations</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/en/2024/05/16/AWS-client-getaddrinfo-EMFILE-issue/"><img src="/en/gallery/thumbnails/aws/lambda.png" alt="AWS client getaddrinfo EMFILE issue"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-05-16T13:17:22.000Z">2024-05-16</time></p><p class="title"><a href="/en/2024/05/16/AWS-client-getaddrinfo-EMFILE-issue/">AWS client getaddrinfo EMFILE issue</a></p><p class="categories"><a href="/en/categories/Explorations/">Explorations</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/en/2024/05/11/How-to-prevent-duplicate-SQS-messages/"><img src="/en/gallery/thumbnails/2024/sqs.png" alt="How to prevent duplicate SQS messages"></a></figure><div class="media-content"><p class="date"><time dateTime="2024-05-10T21:52:05.000Z">2024-05-11</time></p><p class="title"><a href="/en/2024/05/11/How-to-prevent-duplicate-SQS-messages/">How to prevent duplicate SQS messages</a></p><p class="categories"><a href="/en/categories/Explorations/">Explorations</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/en/2020/02/14/novice/cache-memory-issue/"><img src="/en/gallery/thumbnails/troubleshooting.jpg" alt="A bug which should have been solved a week ago"></a></figure><div class="media-content"><p class="date"><time dateTime="2020-02-14T11:05:00.000Z">2020-02-14</time></p><p class="title"><a href="/en/2020/02/14/novice/cache-memory-issue/">A bug which should have been solved a week ago</a></p><p class="categories"><a href="/en/categories/Explorations/">Explorations</a></p></div></article></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/en/tags/Serviceless/"><span class="tag">Serviceless</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/en/tags/AWS/"><span class="tag">AWS</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/en/tags/FE/"><span class="tag">FE</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/en/tags/Client/"><span class="tag">Client</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/en/tags/Amazon-connect/"><span class="tag">Amazon connect</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/en/tags/DynamoDB/"><span class="tag">DynamoDB</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/en/tags/SQS-Processor/"><span class="tag">SQS Processor</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/en/tags/Auth0/"><span class="tag">Auth0</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/en/"><img src="/en/gallery/site/logo.png" alt="Fedeoo&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2024 Fedeoo</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/en/js/column.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/en/js/back_to_top.js" defer></script><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><!--!--><!--!--><!--!--><script src="/en/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/en/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/en/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>